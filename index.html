<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="styles.css">
		<title>Project 1 - H517 - Spring 2023</title>
	</head>

	<body>

        <div class="master">
            <svg id="svg" class="map"></svg>
			<div id="tooltip" class="tooltip"></div>
        </div>
		
	</body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.2/d3.min.js" 
        integrity="sha512-oKI0pS1ut+mxQZdqnD3w9fqArLyILRsT3Dx0B+8RVEXzEk3aNK3J3pWlaGJ8MtTs1oiwyXDAH6hG6jy1sY0YqA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>

    <script>

		const multiplier = 50;
		const offsetX = 1000;
		const offsetY = 950;
		const svg = d3.select("#svg");
		const tooltip = d3.select("#tooltip");

        setupStreets();
		setupPumps();
		setupDeaths();

		const onMouseOver = function(e) {
			let html;
			if (this.dataset.type === "Pump") {
				html = this.dataset.type;
			} else if (this.dataset.type === "Death") {
				html = `${this.dataset.type}<br />${this.dataset.gender}, aged ${this.dataset.age}`;
			}
			tooltip.html(html).style("opacity", 1)
			d3.select(this)
				.style("cursor", "pointer")
				.style("stroke", "red")
				.style("opacity", 1)
		}

		const onMouseMove = function(e)  {
			tooltip.style("transform", `translate(${d3.pointer(e)[0]}px, ${d3.pointer(e)[1]}px)`)
		}

		const onMouseLeave = function(e) {
			tooltip.html("").style("opacity", 0);
			d3.select(this)
				.style("cursor", "pointer")
				.style("stroke", "none")
				.style("opacity", 0.8)
		}


        function setupStreets() {

            d3.json("/data/streets.json").then(data => {

				const g = svg.append("g").attr("class", "streets");

				data.map(d => {
					const streetX = d.map(s => ((1 - s.x) * multiplier + offsetX));
					const streetY = d.map(s => ((1 - s.y) * multiplier + offsetY));
					const line = d3.line()
						.x(d => streetX[d])
						.y(d => streetY[d]);
					g.append("path")
						.datum(d3.range(streetX.length))
						.attr("fill", "none")
						.attr("stroke", "black")
						.attr("d", line);
				});


            });
        
        }

		function setupPumps() {

			d3.csv("/data/pumps.csv").then(data => {
				
				const g = svg.append("g").attr("class", "pumps");

				data.map(d => {
					g.append("rect")
						.attr("data-type", "Pump")
						.attr("x", (1 - d.x) * multiplier + offsetX)
						.attr("y", (1 - d.y) * multiplier + offsetY)
						.attr("width", 8)
						.attr("height", 8)
						.style("transform", "translate(-4px, -4px)")
						.attr("fill", "blue")
						.on("mouseover", onMouseOver)
						.on("mousemove", onMouseMove)
						.on("mouseleave", onMouseLeave)
				});

			});

		}

		function setupDeaths() {

			d3.csv("/data/deaths_age_sex.csv").then(data => {
				
				const g = svg.append("g").attr("class", "deaths");

				data.map(d => {
					let age;
					const gender = parseInt(d.gender) ? "Female" : "Male";
					switch(parseInt(d.age)) {
						case 0:
							age = "0-10"
							break;
						case 1:
							age = "11-20"
							break;
						case 2:
							age = "21-40"
							break;
						case 3:
							age = "41-60"
							break;
						case 4:
							age = "61-80"
							break;
						case 5:
							age = "> 80"
							break;
						default:
							age = "0-10"
							break;
					}
					g.append("circle")
						.attr("data-type", "Death")
						.attr("data-age", age)
						.attr("data-gender", gender)
						.attr("cx", (1 - d.x) * multiplier + offsetX)
						.attr("cy", (1 - d.y) * multiplier + offsetY)
						.attr("r", 2)
						.style("opacity", ".5")
						.on("mouseover", onMouseOver)
						.on("mousemove", onMouseMove)
						.on("mouseleave", onMouseLeave)
				});

			});
			
		}


    </script>

</html>
