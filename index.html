<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="styles.css">
		<title>Project 1 - H517 - Spring 2023</title>
	</head>

	<body>

        <div class="master">
            <svg id="svg" class="map"></svg>
			<div id="tooltip" class="tooltip"></div>
			<div id="filters" class="filters">
				<label for="male">
					<input type="checkbox" id="male" checked />
					Male
				</label>
				<label for="female">
					<input type="checkbox" id="female" checked />
					Female
				</label>
				<label for="age0">
					<input type="checkbox" id="age0" checked />
					Age 0-10
				</label>
				<label for="age1">
					<input type="checkbox" id="age1" checked />
					Age 21-40
				</label>
				<label for="age2">
					<input type="checkbox" id="age2" checked />
					Age 41-60
				</label>
				<label for="age3">
					<input type="checkbox" id="age3" checked />
					Age 61-80
				</label>
				<label for="age4">
					<input type="checkbox" id="age4" checked />
					Age > 80
				</label>
				<label for="pump">
					<input type="checkbox" id="pump" checked />
					Pumps
				</label>
				<label for="street">
					<input type="checkbox" id="street" checked />
					Streets
				</label>
			</div>
        </div>
	</body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.2/d3.min.js" 
        integrity="sha512-oKI0pS1ut+mxQZdqnD3w9fqArLyILRsT3Dx0B+8RVEXzEk3aNK3J3pWlaGJ8MtTs1oiwyXDAH6hG6jy1sY0YqA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>

    <script>

		const multiplier = 50;
		const offsetDataX = multiplier * 0;
		const offsetDataY = multiplier * 20;
		const offsetStreet = 20;
		const svg = d3.select("#svg");
		const tooltip = d3.select("#tooltip");
		const transform = false;

		let minXStreet;
		let minYStreet;

		document.addEventListener("DOMContentLoaded", function(event) {
        	setupSVG();
			const filters = Array.from(document.querySelectorAll("#filters input"));
			filters.forEach(f => {
				f.addEventListener('change', function() {
					const checked = this.checked;
					const clazz = `${this.id}--hide`;
					const items = Array.from(document.querySelectorAll(`#svg .${this.id}`));
					console.log(items);
					items.forEach(item => checked ? item.classList.remove(clazz) : item.classList.add(clazz));
				});
			})
		});

		const onMouseOver = function(e) {
			let html;
			if (this.dataset.type === "Pump") {
				html = this.dataset.type;
			} else if (this.dataset.type === "Death") {
				html = `${this.dataset.type}<br />${this.dataset.gender}, aged ${this.dataset.age}`;
			}
			tooltip.html(html).style("opacity", 1)
		}

		const onMouseMove = function(e)  {
			const translateX = transform ? d3.pointer(e)[0] - (minXStreet + offsetStreet) : d3.pointer(e)[0];
			const translateY = transform ? d3.pointer(e)[1] - (minYStreet + offsetStreet) : d3.pointer(e)[1];
			tooltip.style("transform", `translate(${translateX}px, ${translateY}px)`)
		}

		const onMouseLeave = function(e) {
			tooltip.html("").style("opacity", 0);
		}

		const toggleGender = (gender) => {
			const points = document.querySelectorAll(`.${gender}`);
			console.log(points);
		}

		function setupSVG() {
			setupStreets();
		}


        function setupStreets() {

            d3.json("/data/streets.json").then(streets => {

				const g = svg.append("g").attr("class", "streets");

				streets.map(street => {

					const streetXCoords = street.map(s => s.x * multiplier + offsetDataX);
					const minX = Math.min.apply(Math, streetXCoords);
					if (minXStreet > minX || !minXStreet) {
						minXStreet = minX;
					}

					const streetYCoords = street.map(s => ((1 - s.y) * multiplier + offsetDataY));
					const minY = Math.min.apply(Math, streetYCoords);
					if (minYStreet > minY || !minYStreet) {
						minYStreet = minY;
					}

					const line = d3.line()
						.x(d => streetXCoords[d])
						.y(d => streetYCoords[d]);
					g.append("path")
						.datum(d3.range(streetXCoords.length))
						.attr("stroke", "black")
						.attr("fill", "none")
						.attr("class", "street")
						.attr("d", line);
				});

				transform ? svg.attr("transform", `translate(-${minXStreet - offsetStreet}, -${minYStreet - offsetStreet})`) : ``;

				setupDeaths();

            });
        
        }

		function setupDeaths() {

			d3.csv("/data/deaths_age_sex.csv").then(data => {
				
				const g = svg.append("g").attr("class", "deaths");

				data.map(d => {
					let age;
					const gender = parseInt(d.gender) ? "Female" : "Male";
					switch(parseInt(d.age)) {
						case 0:
							age = "0-10"
							break;
						case 1:
							age = "11-20"
							break;
						case 2:
							age = "21-40"
							break;
						case 3:
							age = "41-60"
							break;
						case 4:
							age = "61-80"
							break;
						case 5:
							age = "> 80"
							break;
						default:
							age = "0-10"
							break;
					}
					g.append("circle")
						.attr("data-type", "Death")
						.attr("data-age", age)
						.attr("data-gender", gender)
						.attr("cx", (d.x) * multiplier + offsetDataX)
						.attr("cy", (1 - d.y) * multiplier + offsetDataY)
						.attr("r", 4)
						.attr("class", `death ${gender.toLocaleLowerCase()} age${d.age}`)
						.on("mouseover", onMouseOver)
						.on("mousemove", onMouseMove)
						.on("mouseleave", onMouseLeave)
				});

			});

			setupPumps();
			
		}

		function setupPumps() {

			d3.csv("/data/pumps.csv").then(data => {
				
				const g = svg.append("g").attr("class", "pumps");

				data.map(d => {
					g.append("rect")
						.attr("data-type", "Pump")
						.attr("x", (d.x) * multiplier + offsetDataX)
						.attr("y", (1 - d.y) * multiplier + offsetDataY)
						.attr("class", "pump")
						.on("mouseover", onMouseOver)
						.on("mousemove", onMouseMove)
						.on("mouseleave", onMouseLeave)
				});

			});

		}


    </script>

</html>
